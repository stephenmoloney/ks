# Kubernetes series part 1

The objective here is to migrate `kubernetes/ks1` to a helm based deployment.

## Prerequisites

- Ensure the docker image has been created and pushed to your private/public docker registry.

```shell
export REGISTRY_DOMAIN=registry.codinghere.com

docker build --file ./web/Dockerfile --tag smoloney/ks:v1 . && \
docker login ${REGISTRY_DOMAIN} && \
docker tag smoloney/ks:v1 ${REGISTRY_DOMAIN}/smoloney/ks:v1 && \
docker push ${REGISTRY_DOMAIN}/smoloney/ks:v1
```

## Create the charts folder

1. Navigate to `helm/ks1`

```sbtshell
cd ks/helm/ks1
```

2. Create starting point helm templates

```shell
helm create ks1
```

- tree of created files 

```shell
helm/ks1
├── app
│   ├── node_modules
│   ├── package.json
│   ├── public
│   ├── README.md
│   ├── src
│   └── yarn.lock
├── charts
├── Chart.yaml
├── images
│   └── app.png
├── ks1-helm.md
├── templates
│   ├── deployment.yaml
│   ├── _helpers.tpl
│   ├── ingress.yaml
│   ├── NOTES.txt
│   └── service.yaml
├── values.yaml
└── web
    └── Dockerfile
``` 
 
3. delete some of the template files

```shell
rm helm/ks1/templates/deployment.yaml && \
rm helm/ks1/templates/service.yaml && \
rm helm/ks1/templates/ingress.yaml && \
rm helm/ks1/templates/NOTES.txt
```

- tree of remaining files

```shell
helm/ks1
├── app
│   ├── node_modules
│   ├── package.json
│   ├── public
│   ├── README.md
│   ├── src
│   └── yarn.lock
├── charts
├── Chart.yaml
├── images
│   └── app.png
├── ks1-helm.md
├── templates
│   ├── _helpers.tpl
├── values.yaml
└── web
    └── Dockerfile
```

4. Create new `service.yaml`, `deployment.yaml` and `ingress.yaml` template files.

5. Update the `values.yaml` file to fulfill the expectations of the template files

6. use helm to launch/create the pods

- from the helm/ks1 directory:

```shell
helm install deployment/ks1/ --name ks1 
```

Initially there were some yaml errors and the following command shows the release ks1 details

```shell
helm ls --all ks1;

NAME    REVISION        UPDATED                         STATUS  CHART           NAMESPACE
ks1     1               Fri Jun 15 21:23:21 2018        FAILED  ks1-0.1.0       default 
```

```shell
helm status ks1;

LAST DEPLOYED: Fri Jun 15 21:23:21 2018
NAMESPACE: default
STATUS: FAILED
```

- to review the yaml generated by the helm charts

```shell
helm get ks1

REVISION: 1
RELEASED: Fri Jun 15 21:23:21 2018
CHART: ks1-0.1.0
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
image:
  pullPolicy: IfNotPresent
  pullSecrets: harbor-registry
  repository: registry.codinghere.com/smoloney/ks
  tag: v1
ingress:
  enabled: true
  host: ks1.185.80.184.161.nip.io
  path: /
  tls: []
nodeSelector: {}
replicaCount: 1
resources: {}
service:
  externalPort: 80
  internalPort: 3000
  livenessProbeDelay: 20
  portName: http
  type: ClusterIP
tolerations: []

HOOKS:
MANIFEST:

---
# Source: ks1/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: ks1
  labels:
    app: ks1
    chart: ks1-0.1.0
    release: ks1
    heritage: Tiller
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 80
    targetPort: 3000
  selector:
    app: ks1
    release: ks1
---
# Source: ks1/templates/deployment.yaml
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: ks1
  labels:
    app: ks1
    chart: ks1-0.1.0
    release: ks1
    heritage: Tiller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ks1
      release: ks1
  template:
    metadata:
      labels:
        app: ks1
        release: ks1
    spec:
      containers:
      - name: ks1
        image: "registry.codinghere.com/smoloney/ks:v1"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3000
        imagePullSecrets:
          - name: harbor-registry
        livenessProbe:
          httpGet:
            path: /
            port: http
            initialDelaySeconds: 20
        readinessProbe:
          httpGet:
            path: /
            port: http
---
# Source: ks1/templates/ingress.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ks1
  labels:
    app: ks1
    chart: ks1-0.1.0
    release: ks1
    heritage: Tiller
spec:
  rules:
  - host: ks1.185.80.184.161.nip.io
    http:
      paths:
        - path: /
          backend:
            serviceName: ks1
            servicePort: $servicePort
```

- to list helm releases in the `default` namespace

```shell
helm list
```

- to rollback a release to a previous version

```shell
helm rollback ks1 <revision_to_rollback_to>
```

- to upgrade a release

```shell
helm upgrade ks1 ./deployments/ks1
```

- to upgrade a release (and install a release if it does not exist yet)

```shell
helm upgrade ks1 ./deployment/ks1 --install
```

- to upgrade a release (and deploy onto a specific namespace)

```shell
helm upgrade ks1 ./deployment/ks1 --install --namespace default
```

- to lint a helm chart

```shell
helm lint deployment/ks1
```

- to delete a broken release

```shell
helm delete ks1
```

- Upon fixing the error in the yaml, file, the release was successfully deployed 
as follows:

```shell
helm upgrade ks1 ./deployment/ks1 --install

Release "ks1" has been upgraded. Happy Helming!
LAST DEPLOYED: Fri Jun 15 21:40:29 2018
NAMESPACE: default
STATUS: DEPLOYED

RESOURCES:
==> v1/Service
NAME  CLUSTER-IP      EXTERNAL-IP  PORT(S)  AGE
ks1   10.111.189.167  <none>       80/TCP   0s

==> v1beta2/Deployment
NAME  KIND
ks1   Deployment.v1beta2.apps

==> v1beta1/Ingress
NAME  HOSTS                      ADDRESS  PORTS  AGE
ks1   ks1.185.80.184.161.nip.io  80       0s
```






