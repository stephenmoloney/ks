# Helm series part 3

The objective here is to migrate `kubernetes/ks3` to a helm based deployment.

## Prerequisites

- Ensure the docker image has been created and pushed to your private/public docker registry.

```shell
export REGISTRY_DOMAIN=registry.codinghere.com
export DOCKER_NAMESPACE=smoloney

docker build --file ./web/Dockerfile --tag ${DOCKER_NAMESPACE}/ks-frontend:v3 . && \
docker build --file ./server/Dockerfile --tag ${DOCKER_NAMESPACE}/ks-backend:v3 .

docker login ${REGISTRY_DOMAIN}

docker tag ${DOCKER_NAMESPACE}/ks-frontend:v3 ${REGISTRY_DOMAIN}/${DOCKER_NAMESPACE}/ks-frontend:v3 && \
docker tag ${DOCKER_NAMESPACE}/ks-backend:v3 ${REGISTRY_DOMAIN}/${DOCKER_NAMESPACE}/ks-backend:v3

docker push ${REGISTRY_DOMAIN}/${DOCKER_NAMESPACE}/ks-frontend:v3 && \
docker push ${REGISTRY_DOMAIN}/${DOCKER_NAMESPACE}/ks-backend:v3
```

- Ensure the docker registry secret has been setup (TODO write about how to do that).

## Create the charts folder

1. Navigate to `helm/ks3`

```sbtshell
cd ks/helm/ks3
```

2. Create starting point helm templates

```shell
helm create ks3
```

- tree of created files 

```shell
helm/ks3
├── app
│   ├── node_modules
│   ├── package.json
│   ├── public
│   ├── README.md
│   ├── src
│   └── yarn.lock
├── charts
├── Chart.yaml
├── images
│   └── app.png
├── ks3-helm.md
├── templates
│   ├── deployment.yaml
│   ├── _helpers.tpl
│   ├── ingress.yaml
│   ├── NOTES.txt
│   └── service.yaml
├── values.yaml
└── web
    └── Dockerfile
``` 
 
3. delete some of the template files

```shell
rm helm/ks3/templates/deployment.yaml && \
rm helm/ks3/templates/service.yaml && \
rm helm/ks3/templates/ingress.yaml && \
rm helm/ks3/templates/NOTES.txt
```

- tree of remaining files

```shell
helm/ks3
├── app
│   ├── node_modules
│   ├── package.json
│   ├── public
│   ├── README.md
│   ├── src
│   └── yarn.lock
├── charts
├── Chart.yaml
├── images
│   └── app.png
├── ks3-helm.md
├── templates
│   ├── _helpers.tpl
├── values.yaml
└── web
    └── Dockerfile
```

4. Create new `service.yaml`, `deployment.yaml` and `ingress.yaml` template files.

5. Update the `values.yaml` file to fulfill the expectations of the template files

6. use helm to launch/create the pods

- from the helm/ks3 directory:

```shell
helm install deployment/ks3/ --name ks3 
```

- response 

```shell
helm ls --all ks3;

NAME    REVISION        UPDATED                         STATUS  CHART           NAMESPACE
ks3     1               Fri Jun 15 21:23:21 2018        FAILED  ks3-0.1.0       default 
```

```shell
helm status ks3;

LAST DEPLOYED: Fri Jun 15 21:23:21 2018
NAMESPACE: default
STATUS: FAILED
```

- to review the yaml generated by the helm charts

```shell
helm get ks3
```

- to list helm releases in the `default` namespace

```shell
helm list
```

- to rollback a release to a previous version

```shell
helm rollback ks3 <revision_to_rollback_to>
```

- to upgrade a release

```shell
helm upgrade ks3 ./deployments/ks3
```

- to upgrade a release (and install a release if it does not exist yet)

```shell
helm upgrade ks3 ./deployment/ks3 --install
```

- to upgrade a release (and deploy onto a specific namespace)

```shell
helm upgrade ks3 ./deployment/ks3 --install --namespace default
```

- to lint a helm chart

```shell
helm lint deployment/ks3
```

- to delete a broken release

```shell
helm delete --purge ks3
```

- Upon fixing the error in the yaml, file, the release was successfully deployed 
as follows:

```shell
helm upgrade ks3 ./deployment/ks3 --install

Release "ks3" has been upgraded. Happy Helming!
LAST DEPLOYED: Fri Jun 15 21:40:29 2018
NAMESPACE: default
STATUS: DEPLOYED

RESOURCES:
==> v1/Service
NAME  CLUSTER-IP      EXTERNAL-IP  PORT(S)  AGE
ks3   10.111.189.167  <none>       80/TCP   0s

==> v1beta2/Deployment
NAME  KIND
ks3   Deployment.v1beta2.apps

==> v1beta1/Ingress
NAME  HOSTS                      ADDRESS  PORTS  AGE
ks3   ks3.185.80.184.161.nip.io  80       0s
```

- To do a dry run of a helm installation/upgrade

```shell
helm upgrade ks3 ./deployment/ks3 --dry-run --debug --install
```
